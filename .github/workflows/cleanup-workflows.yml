name: Cleanup Failed and Cancelled Workflows

on:
  workflow_dispatch:
    inputs:
      days_old:
        description: 'Delete runs older than X days (0 = all)'
        required: false
        default: '0'
        type: string
      dry_run:
        description: 'Dry run (show what would be deleted without deleting)'
        required: false
        default: 'false'
        type: boolean

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            const daysOld = parseInt('${{ github.event.inputs.days_old }}') || 0;
            const dryRun = '${{ github.event.inputs.dry_run }}' === 'true';
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - daysOld);
            
            console.log(`ğŸ§¹ Starting cleanup...`);
            console.log(`ğŸ“… Cutoff date: ${cutoffDate.toISOString()}`);
            console.log(`ğŸ” Dry run: ${dryRun}`);
            console.log('');
            
            let deletedCount = 0;
            let page = 1;
            const perPage = 100;
            
            while (true) {
              // Get workflow runs
              const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: perPage,
                page: page,
                status: 'completed'  // Only get completed runs
              });
              
              if (runs.workflow_runs.length === 0) {
                break;
              }
              
              for (const run of runs.workflow_runs) {
                const runDate = new Date(run.created_at);
                
                // Check if run should be deleted
                const shouldDelete = (
                  (run.conclusion === 'failure' || 
                   run.conclusion === 'cancelled' ||
                   run.conclusion === 'skipped') &&
                  (daysOld === 0 || runDate < cutoffDate)
                );
                
                if (shouldDelete) {
                  const runInfo = `[${run.conclusion.toUpperCase()}] ${run.name} #${run.run_number} (${run.created_at})`;
                  
                  if (dryRun) {
                    console.log(`ğŸ”¹ Would delete: ${runInfo}`);
                  } else {
                    try {
                      await github.rest.actions.deleteWorkflowRun({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        run_id: run.id
                      });
                      console.log(`âœ… Deleted: ${runInfo}`);
                      deletedCount++;
                      
                      // Rate limiting: wait a bit between deletions
                      await new Promise(resolve => setTimeout(resolve, 100));
                    } catch (error) {
                      console.log(`âŒ Failed to delete: ${runInfo}`);
                      console.log(`   Error: ${error.message}`);
                    }
                  }
                }
              }
              
              page++;
              
              // Avoid infinite loop
              if (page > 100) {
                console.log('âš ï¸  Reached page limit (100), stopping...');
                break;
              }
            }
            
            console.log('');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            if (dryRun) {
              console.log(`ğŸ” Dry run completed`);
              console.log(`ğŸ“Š Would delete: ${deletedCount} workflow runs`);
            } else {
              console.log(`âœ… Cleanup completed`);
              console.log(`ğŸ“Š Deleted: ${deletedCount} workflow runs`);
            }
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
